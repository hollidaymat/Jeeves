{
  "originalPath": "/home/jeeves/signal-cursor-controller/src/config.ts",
  "content": "/**\n * Configuration Loader\n * Loads config from .env and config.json with sensible defaults\n */\n\nimport { readFileSync, existsSync } from 'fs';\nimport { resolve, dirname } from 'path';\nimport { fileURLToPath } from 'url';\nimport { config as dotenvConfig } from 'dotenv';\nimport type { Config } from './types/index.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst ROOT_DIR = resolve(__dirname, '..');\n\n// Load .env file\ndotenvConfig({ path: resolve(ROOT_DIR, '.env') });\n\n// Default configuration\nconst defaultConfig: Config = {\n  signal: {\n    number: process.env.SIGNAL_PHONE_NUMBER || '',\n    socket: '/tmp/signal-cli.sock'\n  },\n  security: {\n    allowed_numbers: [],\n    log_unauthorized: true,\n    silent_deny: true\n  },\n  claude: {\n    model: 'claude-sonnet-4-5-20250929',\n    haiku_model: 'claude-3-5-haiku-20241022',\n    max_tokens: 500\n  },\n  projects: {\n    directories: [],\n    scan_depth: 2,\n    markers: ['.git', 'package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml'],\n    exclude: ['node_modules', '.git', 'dist', 'build', '.next']\n  },\n  commands: {\n    cursor: process.platform === 'win32'\n      ? 'C:\\\\Users\\\\matth\\\\AppData\\\\Local\\\\Programs\\\\cursor\\\\resources\\\\app\\\\bin\\\\cursor.cmd'\n      : '/usr/bin/cursor'\n  },\n  terminal: {\n    timeout_ms: 120000,\n    max_output_lines: 200,\n    max_output_chars: 10000,\n    allowed_npm_scripts: ['dev', 'start', 'build', 'test', 'lint', 'format', 'watch', 'serve', 'typecheck'],\n    allowed_git_commands: ['status', 'pull', 'fetch', 'diff', 'log', 'branch', 'stash', 'checkout'],\n    custom_commands: {}\n  },\n  memory: {\n    enabled: true,\n    max_conversations_per_project: 100,\n    max_messages_per_conversation: 50,\n    storage_path: './data/memory.json',\n    auto_summarize: false\n  },\n  prd: {\n    enabled: true,\n    triggers: [\n      \"here's a prd\",\n      \"here is a prd\",\n      \"build this\",\n      \"implement this\",\n      \"implement this spec\",\n      \"here's what i need\",\n      \"execute this prd\",\n      \"prd:\"\n    ],\n    auto_approve: false,\n    checkpoint_frequency: 'none',  // Auto-continue through all phases without waiting\n    auto_commit: true,\n    branch_strategy: 'feature-branch',\n    pause_timeout_minutes: 0  // No timeout since we auto-continue\n  },\n  trust: {\n    enabled: true,\n    initial_level: 2 as const,  // Start at semi-autonomous\n    successful_tasks_required: 10,\n    rollbacks_allowed: 0,\n    time_at_level_minimum_days: 7,\n    monthly_spend_limit: 50,\n    per_task_spend_limit: 10\n  },\n  server: {\n    host: process.env.HOST || '127.0.0.1',\n    port: parseInt(process.env.PORT || '3847', 10),\n    tls: (() => {\n      const keyPath = process.env.TLS_KEY_PATH;\n      const certPath = process.env.TLS_CERT_PATH;\n      if (!keyPath || !certPath || !existsSync(keyPath) || !existsSync(certPath)) return undefined;\n      return { keyPath, certPath };\n    })()\n  },\n  rate_limits: {\n    messages_per_minute: 10,\n    messages_per_hour: 100,\n    messages_per_day: 500\n  },\n  safety: {\n    backupEnabled: true,\n    backupRetentionHours: 24,\n    maxShrinkagePercent: 50,\n    validateContent: true,\n    atomicWrites: true,\n    gitAutoStash: false  // Opt-in - can cause confusion\n  },\n  budgets: {\n    dailyHardCap: 5.00,          // $5/day — everything stops\n    hourlySoftCap: 2.00,         // $2/hr — throttle to Haiku-only\n    circuitBreakerThreshold: 3,  // 3 consecutive failures → pause\n    circuitBreakerPauseMs: 60000,// 60s pause\n    features: {\n      conversation:       { maxTokens: 200,  maxCallsPerPeriod: 0,  periodMs: 3600000,  dailyCap: 0.10 },\n      parser:             { maxTokens: 500,  maxCallsPerPeriod: 0,  periodMs: 0,        dailyCap: 0 },     // core — uncapped\n      prd_builder:        { maxTokens: 2000, maxCallsPerPeriod: 15, periodMs: 3600000,  dailyCap: 2.00 },\n      scout_relevance:    { maxTokens: 150,  maxCallsPerPeriod: 20, periodMs: 86400000, dailyCap: 0.50 },\n      scout_digest:       { maxTokens: 500,  maxCallsPerPeriod: 1,  periodMs: 86400000, dailyCap: 0.01 },\n      security_triage:    { maxTokens: 300,  maxCallsPerPeriod: 10, periodMs: 3600000,  dailyCap: 0.25 },\n      freelance_analysis: { maxTokens: 500,  maxCallsPerPeriod: 5,  periodMs: 86400000, dailyCap: 0.10 },\n      decision_predict:   { maxTokens: 200,  maxCallsPerPeriod: 20, periodMs: 86400000, dailyCap: 0.05 },\n      cursor_refinement:  { maxTokens: 500,  maxCallsPerPeriod: 10, periodMs: 86400000, dailyCap: 0.50 },\n      self_proposals:     { maxTokens: 600,  maxCallsPerPeriod: 2,  periodMs: 86400000, dailyCap: 0.02 },\n      voice_transcription: { maxTokens: 0,  maxCallsPerPeriod: 20, periodMs: 86400000, dailyCap: 0.50 },\n      changelog:          { maxTokens: 200, maxCallsPerPeriod: 10, periodMs: 604800000, dailyCap: 0.05 },\n      cost_advisor:       { maxTokens: 300, maxCallsPerPeriod: 2,  periodMs: 604800000, dailyCap: 0.02 },\n    }\n  },\n  voice: {\n    enabled: process.env.VOICE_ENABLED === 'true',\n    piperUrl: process.env.PIPER_URL || 'http://127.0.0.1:10200',\n    piperVoice: process.env.PIPER_VOICE || 'en_GB-alan-medium',\n    whisperUrl: process.env.WHISPER_URL || 'http://127.0.0.1:10300',\n    wakeModelPath: process.env.VOICE_WAKE_MODEL_PATH || resolve(ROOT_DIR, 'models', 'wake', 'hey_jeeves.onnx')\n  },\n  homelab: {\n    enabled: false,  // Only enable on Linux homelab box\n    stacksDir: '/opt/stacks',\n    configsDir: '/opt/configs',\n    backupsDir: '/opt/backups',\n    dataDir: '/data',\n    maxRamMB: 14336,             // 14GB hard limit (reserve 2GB for OS + Jeeves)\n    monitorInterval: 300000,     // Check every 5 minutes (was 60s, ufw calls are expensive)\n    thresholds: {\n      cpu: { warning: 80, critical: 95 },\n      ram: { warning: 85, critical: 95 },\n      disk: { warning: 80, critical: 90 },\n      temp: { warning: 75, critical: 85 }  // N150 throttles at ~90C\n    }\n  }\n};\n\n/**\n * Load configuration from config.json, merging with defaults\n */\nfunction loadConfig(): Config {\n  const configPath = resolve(ROOT_DIR, 'config.json');\n  \n  if (!existsSync(configPath)) {\n    console.warn('[config] No config.json found, using defaults');\n    console.warn('[config] Copy config.example.json to config.json and customize');\n    return defaultConfig;\n  }\n\n  try {\n    const fileContent = readFileSync(configPath, 'utf-8');\n    const fileConfig = JSON.parse(fileContent) as Partial<Config>;\n    \n    // Deep merge with defaults\n    const merged: Config = {\n      signal: { ...defaultConfig.signal, ...fileConfig.signal },\n      security: { ...defaultConfig.security, ...fileConfig.security },\n      claude: { ...defaultConfig.claude, ...fileConfig.claude },\n      projects: { ...defaultConfig.projects, ...fileConfig.projects },\n      commands: { ...defaultConfig.commands, ...fileConfig.commands },\n      terminal: { ...defaultConfig.terminal, ...fileConfig.terminal },\n      memory: { ...defaultConfig.memory, ...fileConfig.memory },\n      prd: { ...defaultConfig.prd, ...fileConfig.prd },\n      trust: { ...defaultConfig.trust, ...fileConfig.trust },\n      server: { ...defaultConfig.server, ...fileConfig.server },\n      rate_limits: { ...defaultConfig.rate_limits, ...fileConfig.rate_limits },\n      safety: { ...defaultConfig.safety, ...fileConfig.safety },\n      budgets: {\n        ...defaultConfig.budgets,\n        ...((fileConfig as Record<string, unknown>).budgets as Partial<Config['budgets']> || {}),\n        features: {\n          ...defaultConfig.budgets.features,\n          ...(((fileConfig as Record<string, unknown>).budgets as Partial<Config['budgets']>)?.features || {})\n        }\n      },\n      homelab: {\n        ...defaultConfig.homelab,\n        ...(fileConfig as Record<string, unknown>).homelab as Partial<Config['homelab']> || {},\n        thresholds: {\n          ...defaultConfig.homelab.thresholds,\n          ...((((fileConfig as Record<string, unknown>).homelab as Partial<Config['homelab']>)?.thresholds) || {})\n        }\n      },\n      voice: fileConfig.voice !== undefined\n        ? { ...defaultConfig.voice!, ...(fileConfig as Record<string, unknown>).voice as Partial<Config['voice']> }\n        : defaultConfig.voice\n    };\n\n    return merged;\n  } catch (error) {\n    console.error('[config] Error loading config.json:', error);\n    return defaultConfig;\n  }\n}\n\n// Export singleton config\nexport const config = loadConfig();\n\n/** Number to send proactive notifications to (owner's phone). Use first allowed_number, not the bot's own number (which would be Note to Self when phone is linked). */\nexport function getOwnerNumber(): string {\n  const owner = config.security.allowed_numbers[0];\n  return owner || config.signal.number;\n}\n\n// Validate critical configuration\nexport function validateConfig(): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  // API key required for local development (Vercel AI Gateway handles it in prod)\n  if (!process.env.ANTHROPIC_API_KEY) {\n    errors.push('ANTHROPIC_API_KEY environment variable is required');\n  }\n\n  if (config.projects.directories.length === 0) {\n    errors.push('No project directories configured');\n  }\n\n  if (!existsSync(config.commands.cursor)) {\n    errors.push(`Cursor CLI not found at: ${config.commands.cursor}`);\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors\n  };\n}\n\nexport const ROOT = ROOT_DIR;\n",
  "timestamp": "2026-02-14T17:21:34.615Z",
  "taskId": "dev-1771089660950",
  "description": "Add comment at top"
}
{
  "originalPath": "/home/jeeves/signal-cursor-controller/src/core/self-test.ts",
  "content": "// Capabilities: self-test runs jeeves-qa + cognitive health; see docs/CAPABILITY_AUDIT\n/**\n * Jeeves Self-Test\n * Runs the full test suite (jeeves-qa), collects results, and formats a report.\n * Triggered by \"run self test\" command or POST /api/self-test.\n */\n\nimport { spawn } from 'child_process';\nimport { resolve, dirname } from 'path';\nimport { fileURLToPath } from 'url';\nimport { existsSync } from 'fs';\nimport { config } from '../config.js';\nimport { logger } from '../utils/logger.js';\nimport { getGrowthTrend } from './growth-tracker.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst ROOT = resolve(__dirname, '../..');\nconst JEEVES_QA_PATH = resolve(ROOT, '..', 'jeeves-qa');\n\nexport interface SuiteResult {\n  name: string;\n  passed: number;\n  failed: number;\n  skipped: number;\n  failures: string[];\n}\n\nexport interface SelfTestResults {\n  suites: SuiteResult[];\n  totals: { passed: number; failed: number; skipped: number };\n  durationMs: number;\n  cognitive: {\n    contextAssembler: boolean;\n    dbConnected: boolean;\n    layersAvailable: string[];\n    lastTraceAge: number | null;\n  };\n  growth: ReturnType<typeof getGrowthTrend>;\n}\n\nexport interface SelfTestOptions {\n  /** Callback for progress messages (e.g. \"Running self-test...\") */\n  onProgress?: (message: string) => void;\n  /** API base URL for cognitive health check */\n  apiBase?: string;\n}\n\n/**\n * Run the full self-test suite and return formatted results.\n */\nexport async function runSelfTest(options: SelfTestOptions = {}): Promise<SelfTestResults> {\n  const { onProgress, apiBase = `http://127.0.0.1:${config.server.port}` } = options;\n\n  const startTime = Date.now();\n  onProgress?.('Running self-test. This takes 30â€“60 seconds.');\n\n  // 1. Run jeeves-qa with --json --no-llm (fast, machine-readable)\n  const qaResult = await runJeevesQa(apiBase, onProgress);\n\n  // 2. Cognitive pipeline check\n  const cognitive = await checkCognitiveHealth(apiBase);\n\n  // 3. Growth trend\n  const growth = getGrowthTrend(10);\n\n  const durationMs = Date.now() - startTime;\n\n  return {\n    suites: qaResult.suites,\n    totals: qaResult.totals,\n    durationMs,\n    cognitive: {\n      contextAssembler: cognitive.assemblerConnected,\n      dbConnected: cognitive.dbConnected,\n      layersAvailable: cognitive.layersAvailable,\n      lastTraceAge: cognitive.lastTraceAge,\n    },\n    growth,\n  };\n}\n\nasync function runJeevesQa(\n  apiBase: string,\n  onProgress?: (msg: string) => void\n): Promise<{ suites: SuiteResult[]; totals: { passed: number; failed: number; skipped: number } }> {\n  if (!existsSync(JEEVES_QA_PATH) || !existsSync(resolve(JEEVES_QA_PATH, 'src/index.ts'))) {\n    logger.warn('Self-test: jeeves-qa not found', { path: JEEVES_QA_PATH });\n    return { suites: [], totals: { passed: 0, failed: 0, skipped: 0 } };\n  }\n\n  return new Promise((resolvePromise, reject) => {\n    const args = ['src/index.ts', '--json', '--no-llm', '--host', apiBase];\n    const proc = spawn('npx', ['tsx', ...args], {\n      cwd: JEEVES_QA_PATH,\n      timeout: 120_000,\n      env: { ...process.env },\n      stdio: ['ignore', 'pipe', 'pipe'],\n    });\n\n    let stdout = '';\n    let stderr = '';\n\n    proc.stdout?.on('data', (chunk: Buffer) => {\n      stdout += chunk.toString();\n    });\n    proc.stderr?.on('data', (chunk: Buffer) => {\n      stderr += chunk.toString();\n    });\n\n    proc.on('close', (code) => {\n      try {\n        const parsed = JSON.parse(stdout.trim());\n        resolvePromise({\n          suites: parsed.suites ?? [],\n          totals: parsed.totals ?? { passed: 0, failed: 0, skipped: 0 },\n        });\n      } catch {\n        logger.warn('Self-test: jeeves-qa did not return valid JSON', { code, stderr: stderr.slice(0, 200) });\n        resolvePromise({\n          suites: [],\n          totals: { passed: 0, failed: code === 0 ? 0 : 1, skipped: 0 },\n        });\n      }\n    });\n\n    proc.on('error', (err) => {\n      logger.error('Self-test: failed to spawn jeeves-qa', { error: String(err), path: JEEVES_QA_PATH });\n      reject(err);\n    });\n  });\n}\n\nasync function checkCognitiveHealth(apiBase: string): Promise<{\n  assemblerConnected: boolean;\n  dbConnected: boolean;\n  layersAvailable: string[];\n  lastTraceAge: number | null;\n}> {\n  try {\n    const res = await fetch(`${apiBase.replace(/\\/$/, '')}/api/debug/cognitive-health`, {\n      signal: AbortSignal.timeout(5000),\n    });\n    const data = (await res.json()) as {\n      assemblerConnected?: boolean;\n      dbConnected?: boolean;\n      layersAvailable?: string[];\n      lastTraceAge?: number | null;\n    };\n    return {\n      assemblerConnected: data.assemblerConnected ?? false,\n      dbConnected: data.dbConnected ?? false,\n      layersAvailable: data.layersAvailable ?? [],\n      lastTraceAge: data.lastTraceAge ?? null,\n    };\n  } catch {\n    return {\n      assemblerConnected: false,\n      dbConnected: false,\n      layersAvailable: [],\n      lastTraceAge: null,\n    };\n  }\n}\n\n/**\n * Format self-test results for Signal/compact display.\n */\nexport function formatSelfTestReport(results: SelfTestResults): string {\n  const total = results.totals.passed + results.totals.failed;\n  const passRate = total > 0 ? ((results.totals.passed / total) * 100).toFixed(0) : '0';\n  const duration = (results.durationMs / 1000).toFixed(1);\n\n  const cogOnline =\n    (results.cognitive.contextAssembler ? 1 : 0) +\n    (results.cognitive.dbConnected ? 1 : 0);\n  const cogTotal = 2; // contextAssembler + dbConnected as main checks\n\n  const suiteLines = results.suites\n    .map((s) => {\n      const icon = s.failed === 0 ? 'PASS' : 'FAIL';\n      const totalSuite = s.passed + s.failed;\n      return `  ${icon} ${s.name}: ${s.passed}/${totalSuite}`;\n    })\n    .join('\\n');\n\n  const failures = results.suites\n    .filter((s) => s.failures.length > 0)\n    .flatMap((s) => s.failures.map((f) => `  - ${f}`));\n  const failureBlock = failures.length > 0 ? `\\nFailures:\\n${failures.slice(0, 5).join('\\n')}` : '';\n\n  const growthLine = results.growth.status && results.growth.status !== 'UNKNOWN'\n    ? `\\nGrowth: ${results.growth.status}`\n    : '';\n\n  return `SELF-TEST COMPLETE (${duration}s)\n\nScore: ${results.totals.passed}/${total} (${passRate}%)\nCognitive: ${cogOnline}/${cogTotal} systems online\n\nSuites:\n${suiteLines}\n${failureBlock}\n${growthLine}`;\n}\n",
  "timestamp": "2026-02-14T17:53:35.634Z",
  "taskId": "dev-1771091581256",
  "description": "Add comment at top"
}
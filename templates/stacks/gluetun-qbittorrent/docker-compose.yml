# Gluetun + qBittorrent â€” all torrent traffic goes through VPN
# Stack path: /opt/stacks/gluetun-qbittorrent/docker-compose.yml
# Uses main env: signal-cursor-controller/.env (add VPN_* vars there; see README).
# Deploy: copy this dir to /opt/stacks/gluetun-qbittorrent/, then:
#   docker compose -f /opt/stacks/gluetun-qbittorrent/docker-compose.yml up -d
#
# Required in project .env: VPN_* (e.g. VPN_SERVICE_PROVIDER, VPN_TYPE, OPENVPN_* or WIREGUARD_*).

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "8085:8085"       # qBittorrent Web UI
      - "6881:6881"       # qBittorrent torrent (TCP)
      - "6881:6881/udp"   # qBittorrent torrent (UDP)
    env_file:
      - /home/jeeves/signal-cursor-controller/.env
    environment:
      - TZ=America/New_York
      # VPN_* from signal-cursor-controller/.env
    volumes:
      - gluetun_config:/gluetun
      - /data/downloads:/data/downloads
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - WEBUI_PORT=8085
    volumes:
      - qbittorrent_config:/config
      - /data/downloads:/data/downloads
    restart: unless-stopped

volumes:
  gluetun_config: {}
  qbittorrent_config: {}
